<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Comprehensive Prostate Nomogram Example</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; }
    .field { margin-bottom: 12px; }
    label { display: inline-block; width: 250px; font-weight: bold; }
    input, select { width: 200px; }
    #calculateBtn { margin-top: 20px; padding: 8px 16px; cursor: pointer; }
    .results { margin-top: 20px; }
    .results p { margin: 8px 0; }
    .warning { color: red; margin: 12px 0; }
    .disclaimer { margin-top: 30px; font-size: 0.9em; color: #444; }
  </style>
</head>
<body>

  <h1>Comprehensive Prostate Nomogram Demo</h1>
  <p>
    This is an <strong>unofficial</strong> example illustrating how to compute multiple 
    endpoints from MSK’s published coefficients. <strong>Not for clinical use!</strong>
  </p>

  <!-- PART A: Basic Input -->
  <div class="field">
    <label>Currently on Hormone Therapy?</label>
    <select id="hormoneTherapy">
      <option value="No" selected>No</option>
      <option value="Yes">Yes (Model not valid)</option>
    </select>
  </div>
  <div class="field">
    <label>Currently on Radiation Therapy?</label>
    <select id="radiationTherapy">
      <option value="No" selected>No</option>
      <option value="Yes">Yes (Model not valid)</option>
    </select>
  </div>

  <hr />

  <div class="field">
    <label for="ageInput">Patient Age (20–99):</label>
    <input type="number" id="ageInput" value="65" min="20" max="99" step="1">
  </div>

  <div class="field">
    <label for="psaInput">Pre-Treatment PSA (0.1–100):</label>
    <input type="number" id="psaInput" value="5.0" step="0.1" min="0.1" max="100">
  </div>

  <!-- Gleason Grade Group (1..5) -->
  <div class="field">
    <label for="gggSelect">Biopsy Gleason Grade Group:</label>
    <select id="gggSelect">
      <option value="1" selected>Group 1 (Gleason 6)</option>
      <option value="2">Group 2 (3+4=7)</option>
      <option value="3">Group 3 (4+3=7)</option>
      <option value="4">Group 4 (Gleason 8)</option>
      <option value="5">Group 5 (Gleason 9-10)</option>
    </select>
  </div>

  <!-- Clinical Stage -->
  <div class="field">
    <label for="stageSelect">Clinical Stage (AJCC v7):</label>
    <select id="stageSelect">
      <option value="T1" selected>T1 (ref)</option>
      <option value="T2a">T2a</option>
      <option value="T2b">T2b</option>
      <option value="T2c">T2c</option>
      <option value="T3">T3 or T3+</option>
    </select>
  </div>

  <div class="field">
    <label for="posCoresInput">Number of Positive Cores:</label>
    <input type="number" id="posCoresInput" value="3" min="0" max="20" step="1">
  </div>

  <div class="field">
    <label for="negCoresInput">Number of Negative Cores:</label>
    <input type="number" id="negCoresInput" value="9" min="0" max="20" step="1">
  </div>

  <button id="calculateBtn">Calculate All</button>
  <div id="warnings" class="warning"></div>

  <div class="results" id="results"></div>

  <div class="disclaimer">
    <strong>Disclaimer:</strong> Unofficial educational demo. 
    Not validated, not medical advice. 
    Refer to <a href="https://www.mskcc.org/nomograms/prostate/pre_op/coefficients" target="_blank">MSK’s official website</a>.
  </div>

  <script>
    /********************************************************************
     * 1) LOGISTIC MODELS: 
     *    We'll define separate coefficient objects for each endpoint:
     *    - Organ Confined Disease (Cores)
     *    - Extracapsular Extension (Cores)
     *    - Lymph Node Involvement (Cores)
     *    - Seminal Vesicle Invasion (Cores)
     ********************************************************************/

    // EXAMPLE: "Organ Confined Disease (Cores)" 
    // from the data you pasted (intercept=4.0476, etc.)
    const COEFF_OCD = {
      intercept: 4.04759847,
      age:       -0.02874416,
      psa:       -0.25142694,
      psaSpline1:  0.00170562,
      psaSpline2: -0.0047362,
      ggg2: -0.66507525,
      ggg3: -1.24440478,
      ggg4: -1.24556939,
      ggg5: -2.29909232,
      stageT2a: -0.24874093,
      stageT2b: -0.77330003,
      stageT2c: -0.57018419,
      stageT3:  -1.47216113,
      posCores: -0.08590313,
      negCores:  0.06308424
    };

    // EXAMPLE: "Extracapsular Extension (Cores)"
    // Replace placeholders with real values from “Extracapsular Extension (Cores)” row
    const COEFF_ECE = {
      intercept:  -4.12316412,
      age:         0.03002483,
      psa:         0.24631397,
      psaSpline1: -0.00173719,
      psaSpline2:  0.00483196,
      ggg2:  0.63224646,
      ggg3:  1.12707867,
      ggg4:  1.16261692,
      ggg5:  2.14168233,
      stageT2a: 0.23208997,
      stageT2b: 0.78324104,
      stageT2c: 0.61674852,
      stageT3:  1.4802089,
      posCores: 0.08822019,
      negCores: -0.06245231
    };

    // EXAMPLE: “Lymph Node Involvement (Cores)”
    const COEFF_LN = {
      intercept:  -5.55716924,
      age:         0.01383913,
      psa:         0.19989322,
      psaSpline1: -0.00137288,
      psaSpline2:  0.00379338,
      ggg2:  0.96607022,
      ggg3:  1.98186216,
      ggg4:  2.13543564,
      ggg5:  2.74999239,
      stageT2a: 0.20425873,
      stageT2b: 0.56977406,
      stageT2c: 0.5132864,
      stageT3:  0.92021757,
      posCores: 0.06832617,
      negCores: -0.08827788
    };

    // EXAMPLE: “Seminal Vesicle Invasion (Cores)”
    const COEFF_SVI = {
      intercept:  -6.34416925,
      age:         0.02294635,
      psa:         0.27708214,
      psaSpline1: -0.0022032,
      psaSpline2:  0.00615729,
      ggg2:  1.01060597,
      ggg3:  1.85561279,
      ggg4:  1.99375384,
      ggg5:  2.95409228,
      stageT2a: 0.13413385,
      stageT2b: 0.40933437,
      stageT2c: 0.76647585,
      stageT3:  0.80547871,
      posCores: 0.07534199,
      negCores: -0.12050282
    };

    /********************************************************************
     * 2) SURVIVAL MODELS:
     *    For example, “Preoperative BCR (Cores)” or “Preoperative Prostate
     *    Cancer Death (Cores)” from your data. 
     * 
     *    We’ll show how to do 5-year, 10-year, 15-year by plugging in T=5,
     *    T=10, T=15 into the parametric formula. 
     * 
     *    We'll provide placeholders for “Preoperative BCR (Cores)” 
     *    and “Preoperative Prostate Cancer Death (Cores)”.
     ********************************************************************/

    // EXAMPLE: “Preoperative BCR (Cores)” survival
    const COEFF_BCR_CORES = {
      intercept:  6.59468768,
      age:       -0.00527992,
      psa:       -0.4707596,
      psaSpline1:  0.00407629,
      psaSpline2: -0.01141213,
      ggg2: -1.0072232,
      ggg3: -2.02462439,
      ggg4: -2.49980646,
      ggg5: -2.80520499,
      stageT2a: -0.3285729,
      stageT2b: -0.65148102,
      stageT2c: -0.61816331,
      stageT3:  -0.93665289,
      posCores: -0.05378144,
      negCores:  0.03456631,
      gamma:     1.06458144  // Scaling parameter
    };

    // EXAMPLE: “Preoperative Prostate Cancer Death (Cores)”
    // This uses the *BCR-free probability at 5 years* from the full pre-op model
    // as a single covariate (!) plus intercept, gamma, etc.
    // The table says: Intercept=2.49813214, Covariate=2.24491531, gamma=0.40929215
    const COEFF_PCD_CORES = {
      intercept: 2.49813214,
      bcrCoef:   2.24491531,  // The model uses "5-year BCR-free probability" *as the covariate*
      gamma:     0.40929215
    };

    /********************************************************************
     * 3) RESTRICTED CUBIC SPLINE for PSA
     *    The knots are given: k1=0.2, k2=4.8, k3=7.33, k4=307 (same set used in your data)
     ********************************************************************/
    const PSA_KNOTS = { k1: 0.2, k2: 4.8, k3: 7.33, k4: 307 };

    function rcsTerm(x, knot) {
      return Math.max(x - knot, 0) ** 3;
    }
    function psaSpline(PSA) {
      const {k1, k2, k3, k4} = PSA_KNOTS;
      const sp1 = 
        rcsTerm(PSA, k1) 
        - rcsTerm(PSA, k3)*(k4-k1)/(k4-k3)
        + rcsTerm(PSA, k4)*(k3-k1)/(k4-k3);
      const sp2 = 
        rcsTerm(PSA, k2) 
        - rcsTerm(PSA, k3)*(k4-k2)/(k4-k3)
        + rcsTerm(PSA, k4)*(k3-k2)/(k4-k3);
      return { sp1, sp2 };
    }

    /********************************************************************
     * 4) LOGISTIC MODEL HELPER
     ********************************************************************/
    function logisticProbability(xb) {
      const eXb = Math.exp(xb);
      return eXb / (1 + eXb);
    }

    /**
     * Given coefficients for a logistic model, plus user inputs,
     * compute the linear predictor, then logistic probability.
     */
    function calcLogisticModel(coeff, inputs) {
      // Step 1: spline terms for PSA
      const { sp1, sp2 } = psaSpline(inputs.psa);

      // Step 2: start with intercept
      let xb = coeff.intercept;

      // Step 3: add linear terms
      xb += (coeff.age       ?? 0) * inputs.age;
      xb += (coeff.psa       ?? 0) * inputs.psa;
      xb += (coeff.psaSpline1 ?? 0) * sp1;
      xb += (coeff.psaSpline2 ?? 0) * sp2;

      // Step 4: add Gleason GGG effect
      if (inputs.ggg === 2) xb += (coeff.ggg2 ?? 0);
      if (inputs.ggg === 3) xb += (coeff.ggg3 ?? 0);
      if (inputs.ggg === 4) xb += (coeff.ggg4 ?? 0);
      if (inputs.ggg === 5) xb += (coeff.ggg5 ?? 0);

      // Step 5: clinical stage
      if (inputs.stage === 'T2a') xb += (coeff.stageT2a ?? 0);
      if (inputs.stage === 'T2b') xb += (coeff.stageT2b ?? 0);
      if (inputs.stage === 'T2c') xb += (coeff.stageT2c ?? 0);
      if (inputs.stage === 'T3')  xb += (coeff.stageT3  ?? 0);

      // Step 6: positive/negative cores
      xb += (coeff.posCores ?? 0) * inputs.posCores;
      xb += (coeff.negCores ?? 0) * inputs.negCores;

      // Step 7: logistic transform
      return logisticProbability(xb);
    }

    /********************************************************************
     * 5) SURVIVAL MODEL HELPER
     *    parametric formula for BCR or other event:
     *      P(event-free @ time T) = 1 / [ 1 + ( (e^-Xβ)*T )^(1/gamma ) ]
     ********************************************************************/
    function calcSurvivalProbability(coeff, inputs, timeYears) {
      // Step 1: compute linear predictor (similar to logistic but we do NOT logistic transform)
      const { sp1, sp2 } = psaSpline(inputs.psa);

      let xb = coeff.intercept;
      xb += (coeff.age ?? 0) * inputs.age;
      xb += (coeff.psa ?? 0) * inputs.psa;
      xb += (coeff.psaSpline1 ?? 0) * sp1;
      xb += (coeff.psaSpline2 ?? 0) * sp2;

      // Gleason GGG
      if (inputs.ggg === 2) xb += (coeff.ggg2 ?? 0);
      if (inputs.ggg === 3) xb += (coeff.ggg3 ?? 0);
      if (inputs.ggg === 4) xb += (coeff.ggg4 ?? 0);
      if (inputs.ggg === 5) xb += (coeff.ggg5 ?? 0);

      // Stage
      if (inputs.stage === 'T2a') xb += (coeff.stageT2a ?? 0);
      if (inputs.stage === 'T2b') xb += (coeff.stageT2b ?? 0);
      if (inputs.stage === 'T2c') xb += (coeff.stageT2c ?? 0);
      if (inputs.stage === 'T3')  xb += (coeff.stageT3  ?? 0);

      // cores
      xb += (coeff.posCores ?? 0) * inputs.posCores;
      xb += (coeff.negCores ?? 0) * inputs.negCores;

      const gamma = coeff.gamma;  // scaling param

      // Step 2: parametric formula
      // e^-Xβ = Math.exp( -xb )
      // => P(event-free @ T) = 1 / [ 1 + ( ( e^-Xβ ) * T )^(1/gamma ) ]
      const eNegXb = Math.exp(-xb);
      const numerator = 1;
      const denominator = 1 + Math.pow(eNegXb * timeYears, 1 / gamma);
      const probEventFree = numerator / denominator;

      return probEventFree;
    }

    /**
     * Some survival models for *prostate cancer death* are built
     * on top of the *5-year BCR-free probability* from the “full BCR model.”
     * 
     * If the table says:
     *   intercept = 2.49813214
     *   bcrCoef   = 2.24491531
     *   gamma     = 0.40929215
     * 
     * Then the linear predictor is: 
     *   LP = intercept + bcrCoef * (BCR-free prob @5yrs from that model)
     * 
     * And the survival formula is the same parametric shape:
     *   P(PC-death-free @ T) = 1 / [ 1 + ( ( e^-LP ) * T )^(1/gamma ) ]
     */
    function calcPCDeathProbability(coeffPCD, bcrFree5, timeYears) {
      // bcrFree5 = survival probability from the BCR model at 5 years
      // linear predictor:
      const xb = coeffPCD.intercept + coeffPCD.bcrCoef * bcrFree5;
      const gamma = coeffPCD.gamma;

      // param formula => PC-death-free at T
      const eNegXb = Math.exp(-xb);
      const numerator = 1;
      const denominator = 1 + Math.pow(eNegXb * timeYears, 1 / gamma);
      const probPCDeathFree = numerator / denominator;

      return probPCDeathFree; // Probability of *not* dying of PC by year T
    }

    /********************************************************************
     * 6) MAIN: “Calculate All” 
     ********************************************************************/
    document.getElementById('calculateBtn').addEventListener('click', () => {
      const warnings = document.getElementById('warnings');
      warnings.textContent = '';

      // Check hormone/radiation
      const hormone = document.getElementById('hormoneTherapy').value;
      const radiation = document.getElementById('radiationTherapy').value;
      if (hormone === 'Yes' || radiation === 'Yes') {
        warnings.textContent = 
          'Model disclaimers: Not valid if patient is on hormone or radiation therapy.';
      }

      // Gather numeric input
      const ageVal = parseFloat(document.getElementById('ageInput').value) || 0;
      const psaVal = parseFloat(document.getElementById('psaInput').value) || 0;
      const gggVal = parseInt(document.getElementById('gggSelect').value, 10);
      const stageVal = document.getElementById('stageSelect').value;
      const posCoresVal = parseFloat(document.getElementById('posCoresInput').value) || 0;
      const negCoresVal = parseFloat(document.getElementById('negCoresInput').value) || 0;

      // Build input object
      const inputData = {
        age: ageVal,
        psa: psaVal,
        ggg: gggVal,      // 1..5
        stage: stageVal,  // T1, T2a, T2b...
        posCores: posCoresVal,
        negCores: negCoresVal
      };

      // ---- LOGISTIC ENDPOINTS ----
      const probOCD = calcLogisticModel(COEFF_OCD, inputData);
      const probECE = calcLogisticModel(COEFF_ECE, inputData);
      const probLN  = calcLogisticModel(COEFF_LN,  inputData);
      const probSVI = calcLogisticModel(COEFF_SVI, inputData);

      // ---- SURVIVAL ENDPOINTS: BCR @ 5y, 10y ----
      const probBCR5  = calcSurvivalProbability(COEFF_BCR_CORES, inputData, 5);
      const probBCR10 = calcSurvivalProbability(COEFF_BCR_CORES, inputData, 10);

      // ---- 15-year PROSTATE CANCER–SPECIFIC SURVIVAL ----
      // This typically uses a 2-step approach if the model says:
      // “Use 5-year BCR-free prob from full pre-op model -> feed into PC Death model.”
      // 1) We already have probBCR5 (the BCR-free prob at 5 yrs).
      // 2) Use COEFF_PCD_CORES to get “PC death–free” at T=15
      const pcDeathFree15 = calcPCDeathProbability(COEFF_PCD_CORES, probBCR5, 15);
      const pcSurvival15 = pcDeathFree15; 
      // (If the model truly is "Probability of NOT dying from PC," 
      //  then pcSurvival15 is that number.)

      // Populate results
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `
        <p><strong>Organ Confined Disease (Cores) Prob:</strong> ${(probOCD*100).toFixed(1)}%</p>
        <p><strong>Extracapsular Extension (Cores) Prob:</strong> ${(probECE*100).toFixed(1)}%</p>
        <p><strong>Lymph Node Involvement (Cores) Prob:</strong> ${(probLN*100).toFixed(1)}%</p>
        <p><strong>Seminal Vesicle Invasion (Cores) Prob:</strong> ${(probSVI*100).toFixed(1)}%</p>
        <hr/>
        <p><strong>Progression-Free @ 5 years (Pre-op BCR, Cores):</strong> ${(probBCR5*100).toFixed(1)}%</p>
        <p><strong>Progression-Free @ 10 years:</strong> ${(probBCR10*100).toFixed(1)}%</p>
        <hr/>
        <p><strong>Prostate Cancer-Specific Survival @ 15 years:</strong> ${(pcSurvival15*100).toFixed(1)}%</p>
      `;
    });
  </script>

</body>
</html>
